<script type="module">
  import { createWeb3Modal, defaultWagmiConfig } from "https://unpkg.com/@web3modal/wagmi@3?module";
  import { base } from "https://unpkg.com/viem/chains@2?module";

  const WALLETCONNECT_PROJECT_ID = "48b334d8de52dbd9b8961aa95b361027";
  const NEYNAR_API_KEY = "3F17B1A2-18B4-4EB9-8F64-301575EF94D0";

  const btnMain = document.getElementById("btnMain");
  const modal = document.getElementById("loginModal");
  const optWallet = document.getElementById("optWallet");
  const optFarcaster = document.getElementById("optFarcaster");

  let loggedIn = false;

  // === Setup WalletConnect ===
  const wagmiConfig = defaultWagmiConfig({
    chains: [base],
    projectId: WALLETCONNECT_PROJECT_ID,
    metadata: {
      name: "WAQIT Game Portal",
      description: "Portal Game Futuristik",
      url: location.origin,
      icons: ["/logo.png"]
    }
  });

  createWeb3Modal({
    wagmiConfig,
    projectId: WALLETCONNECT_PROJECT_ID,
    chains: [base]
  });

  // Klik tombol utama
  btnMain.addEventListener("click", () => {
    if (!loggedIn) {
      modal.style.display = "flex";
    } else {
      window.location.href = "/games/snake/index.html";
    }
  });

  // Klik WalletConnect
  optWallet.addEventListener("click", async () => {
    try {
      // ini bakal munculin modal walletconnect
      window.open("https://explorer.walletconnect.com/?projectId=" + WALLETCONNECT_PROJECT_ID, "_blank");
      afterLogin("WalletConnect");
    } catch (err) {
      alert("WalletConnect gagal");
      console.error(err);
    }
  });

  // Klik Farcaster
  optFarcaster.addEventListener("click", async () => {
    try {
      const res = await fetch("https://api.neynar.com/v2/farcaster/user", {
        headers: { "api_key": NEYNAR_API_KEY }
      });
      if (res.ok) {
        afterLogin("Farcaster");
      } else {
        alert("Login Farcaster gagal");
      }
    } catch (err) {
      alert("Error Farcaster");
      console.error(err);
    }
  });

  function afterLogin(method) {
    loggedIn = true;
    btnMain.textContent = "ðŸŽ® Main Game";
    modal.style.display = "none";
    console.log("Login sukses via", method);
  }

  window.closeModal = () => modal.style.display = "none";
</script>
